/**
 * @file Firebase Security Rules for PredictPro Firestore Database
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for most data, supplemented by role-based access for administrative functions.
 * Users can only access their own data, while administrative roles (Admin, Assistant, SuperAdmin) have broader permissions.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles; all user-related data is nested under this path.
 * - /users/{userId}/otps/{otpId}: Stores one-time passwords for user verification.
 * - /users/{userId}/licenses/{licenseId}: Stores user licenses.
 * - /users/{userId}/transactions/{transactionId}: Stores user transactions.
 * - /users/{userId}/predictions/{predictionId}: Stores user predictions.
 * - /users/{userId}/auditlogs/{auditLogId}: Stores audit logs for user actions.
 * - /supporttickets/{supportTicketId}: Stores support tickets.
 * - /supporttickets/{supportTicketId}/supportmessages/{supportMessageId}: Stores messages associated with a support ticket.
 * - /users/{userId}/assistantcontracts/{assistantContractId}: Stores contracts for assistants.
 * - /referrals/{referralId}: Stores referral data.
 * - /commissions/{commissionId}: Stores commission data.
 * - /withdrawalrequests/{withdrawalRequestId}: Stores withdrawal requests.
 * - /analyticsevents/{analyticsEventId}: Stores analytics events.
 * - /analyticsaggregations/{analyticsAggregationId}: Stores aggregated analytics metrics.
 * - /usersessions/{userSessionId}: Stores user session data.
 *
 * Key Security Decisions:
 * - User-specific data is secured using path-based ownership.
 * - Administrative roles are not yet implemented, but the structure anticipates their addition.
 * - Data validation is relaxed to allow for rapid prototyping and schema evolution, focusing on authorization.
 * - All write operations are explicitly authorized to prevent accidental data modification.
 * - List operations on user-scoped subcollections default to owner-only access.
 *
 * Denormalization for Authorization:
 * - The 'role' field is stored directly within the /users/{userId} document to simplify role-based access checks.
 * - Each document under the user id requires the userId in the document.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by a signed-in user.
     * @return {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the document.
     * @param {string} userId - The user ID to compare against the request's auth UID.
     * @return {boolean} True if the user ID matches the request's auth UID, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the owner of an existing document.
     * @param {string} userId - The user ID to compare against the resource's data.
     * @return {boolean} True if the user is the owner and the resource exists.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rules for user profiles.
     * @path /users/{userId}
     * @allow (create) User with ID 'user123' creates their own profile.
     *   - auth.uid: 'user123'
     *   - request.resource.data.id: 'user123'
     * @allow (get) User with ID 'user123' reads their own profile.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' tries to create a profile for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.id: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false; // Listing all users is not permitted.
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for OTPs for a specific user.
     * @path /users/{userId}/otps/{otpId}
     * @allow (create) User with ID 'user123' creates an OTP.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @allow (get) User with ID 'user123' reads their OTP.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' tries to create an OTP for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.userId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/otps/{otpId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for game licenses for a specific user.
     * @path /users/{userId}/licenses/{licenseId}
     * @allow (create) User with ID 'user123' creates a license.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @allow (get) User with ID 'user123' reads their license.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' tries to create a license for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.userId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/licenses/{licenseId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for payment transactions for a specific user.
     * @path /users/{userId}/transactions/{transactionId}
     * @allow (create) User with ID 'user123' creates a transaction.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @allow (get) User with ID 'user123' reads their transaction.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' tries to create a transaction for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.userId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/transactions/{transactionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for game predictions for a specific user.
     * @path /users/{userId}/predictions/{predictionId}
     * @allow (create) User with ID 'user123' creates a prediction.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @allow (get) User with ID 'user123' reads their prediction.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' tries to create a prediction for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.userId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/predictions/{predictionId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for audit logs for a specific user.
     * @path /users/{userId}/auditlogs/{auditLogId}
     * @allow (create) User with ID 'user123' creates an audit log.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @allow (get) User with ID 'user123' reads their audit log.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' tries to create an audit log for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.userId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/auditlogs/{auditLogId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for support tickets.
     * @path /supporttickets/{supportTicketId}
     * @allow (create) User with ID 'user123' creates a support ticket with the correct user ID.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @allow (get) Any signed-in user can read any support ticket.
     *   - auth.uid: 'any_user'
     * @deny (create) User with ID 'user456' tries to create a support ticket for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.userId: 'user123'
     * @principle Allows users to create and read support tickets.
     */
    match /supporttickets/{supportTicketId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn(); // Any signed-in user can list support tickets
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isSignedIn() && resource.data.userId == request.auth.uid;
      allow delete: if false; // No one can delete support tickets.
    }

    /**
     * @description Rules for support messages for a specific support ticket.
     * @path /supporttickets/{supportTicketId}/supportmessages/{supportMessageId}
     * @allow (create) User with ID 'user123' creates a support message with the correct sender ID.
     *   - auth.uid: 'user123'
     *   - request.resource.data.senderId: 'user123'
     *   - resource.data.ticketId: 'ticket123'
     * @allow (get) Any signed-in user can read any support message, provided they can read the ticket.
     *   - auth.uid: 'any_user'
     * @deny (create) User with ID 'user456' tries to create a support message for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.senderId: 'user123'
     * @principle Allows users to create and read support messages if they are the sender.
     */
    match /supporttickets/{supportTicketId}/supportmessages/{supportMessageId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn(); // Anyone who can read the ticket can read the messages
      allow create: if isSignedIn() && request.resource.data.senderId == request.auth.uid;
      allow update: if false; // No updates allowed.
      allow delete: if false; // No deletes allowed.
    }

    /**
     * @description Rules for assistant contracts for a specific user.
     * @path /users/{userId}/assistantcontracts/{assistantContractId}
     * @allow (create) User with ID 'user123' creates an assistant contract.
     *   - auth.uid: 'user123'
     *   - request.resource.data.userId: 'user123'
     * @allow (get) User with ID 'user123' reads their assistant contract.
     *   - auth.uid: 'user123'
     * @deny (create) User with ID 'user456' tries to create an assistant contract for 'user123'.
     *   - auth.uid: 'user456'
     *   - request.resource.data.userId: 'user123'
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/assistantcontracts/{assistantContractId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for referral information.
     * @path /referrals/{referralId}
     * @allow (create) Any signed-in user can create a referral.
     *   - auth.uid: 'user123'
     * @allow (get) Any signed-in user can read any referral.
     *   - auth.uid: 'any_user'
     * @deny (update) No one can update referrals.
     * @principle Allows anyone to read referrals.
     */
    match /referrals/{referralId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for commission information.
     * @path /commissions/{commissionId}
     * @allow (create) Any signed-in user can create a commission.
     *   - auth.uid: 'user123'
     * @allow (get) Any signed-in user can read any commission.
     *   - auth.uid: 'any_user'
     * @deny (update) No one can update commissions.
     * @principle Allows anyone to read commissions.
     */
    match /commissions/{commissionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for withdrawal requests.
     * @path /withdrawalrequests/{withdrawalRequestId}
     * @allow (create) User with ID 'user123' creates a withdrawal request.
     *   - auth.uid: 'user123'
     * @allow (get) Any signed-in user can read any withdrawal request.
     *   - auth.uid: 'any_user'
     * @deny (update) No one can update withdrawal requests.
     * @principle Allows anyone to read withdrawal requests.
     */
    match /withdrawalrequests/{withdrawalRequestId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for analytics events.
     * @path /analyticsevents/{analyticsEventId}
     * @allow (create) User with ID 'user123' creates an analytics event.
     *   - auth.uid: 'user123'
     * @allow (get) Any signed-in user can read any analytics event.
     *   - auth.uid: 'any_user'
     * @deny (update) No one can update analytics events.
     * @principle Allows anyone to read analytics events.
     */
    match /analyticsevents/{analyticsEventId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for aggregated analytics metrics.
     * @path /analyticsaggregations/{analyticsAggregationId}
     * @allow (create) Any signed-in user can create an analytics aggregation.
     *   - auth.uid: 'user123'
     * @allow (get) Any signed-in user can read any analytics aggregation.
     *   - auth.uid: 'any_user'
     * @deny (update) No one can update analytics aggregations.
     * @principle Allows anyone to read analytics aggregations.
     */
    match /analyticsaggregations/{analyticsAggregationId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Rules for user sessions.
     * @path /usersessions/{userSessionId}
     * @allow (create) User with ID 'user123' creates a user session.
     *   - auth.uid: 'user123'
     * @allow (get) Any signed-in user can read any user session.
     *   - auth.uid: 'any_user'
     * @deny (update) No one can update user sessions.
     * @principle Allows anyone to read user sessions.
     */
    match /usersessions/{userSessionId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if false;
      allow delete: if false;
    }
  }
}